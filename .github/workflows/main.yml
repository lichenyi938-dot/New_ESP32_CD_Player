name: Build ESP32-S3 Firmware

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    # 用官方 ESP-IDF 容器跑整个 Job，避免路径/环境不一致
    container:
      image: espressif/idf:v5.1.1   # 也可换成你需要的版本

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show workspace tree (debug)
        run: |
          echo "GITHUB_WORKSPACE = $GITHUB_WORKSPACE"
          ls -la
          ls -la original_ok/ESP32_CD_Player-main || true

      - name: Build (ESP32-S3)
        working-directory: original_ok/ESP32_CD_Player-main
        shell: bash
        run: |
          # 激活 IDF 环境（容器里已自带）
          . $IDF_PATH/export.sh
          idf.py --version
          # 指定目标并编译
          idf.py set-target esp32s3
          idf.py build

      - name: Upload build results
        uses: actions/upload-artifact@v4
        with:
          name: ESP32_S3_Firmware
          path: original_ok/ESP32_CD_Player-main/build
